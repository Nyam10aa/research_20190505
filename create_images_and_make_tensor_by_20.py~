#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pandas as pd
from PIL import Image
import boto3
import io
import numpy as np
import random

#name = ["result_step_001001.csv","result_step_001051.csv"]
err_case=["003081","003082","003083","003084","003085","003086","003087","003088","003089","003090","003091","003092","003093","003094","003095","003096","003097","003098","003099","003100","009094","009095","009096","009097","009098","009099","009100","012064","012065","012082","012083","012084","012085","012086","012087","012088","012089","012090","012091","012092","012093","012094","012095","012096","012097","012098","012099","012100","014097","014098","014099","014100","015082","015083","015084","015085","015086","015087","015088","015089","015090","015091","015092","015093","015094","015095","015096","015097","015098","015099","015100","016069","016070","016071","016072","016073","016074","016075","016076","016077","016078","016079","016080","016081","016082","016083","016084","016085","016086","016087","016088","016089","016090","016091","016092","016093","016094","016095","016096","016097","016098","016099","016100","017099","017100","018095","019082","019083","019084","019085","019086","019087","019088","019089","019090","019091","019092","019093","019094","019095","019096","019097","019098","019099","019100","021090","021091","021092","021093","021094","021095","021096","021097","021098","021099","021100","022078","022079","022080","022081","022082","022083","022084","022085","022086","022087","022088","022089","022090","022091","022092","022093","022094","022095","022096","022097","022098","022099","022100","024078","024079","024080","024081","024082","024083","024084","024085","024086","024087","024088","024089","024090","024091","024092","024093","024094","024095","024096","024097","024098","024099","024100","025089","025094","025095","025096","025097","025098","025099","025100","027092","027093","027094","027095","027096","027097","027098","027099","027100","028069","028070","028071","028072","028073","028074","028075","028076","028077","028078","028079","028080","028081","028082","028083","028084","028085","028086","028087","028088","028089","028090","028091","028092","028093","028094","028095","028096","028097","028098","028099","028100","029062","029063","029064","029065","029066","029067","029068","029069","029070","029071","029072","029073","029074","029075","029076","029077","029078","029079","029080","029081","029082","029083","029084","029085","029086","029087","029088","029089","029090","029091","029092","029093","029094","029095","029096","029097","029098","029099","029100","030081","030085","030089","030090","030094","030095","030099","030100","032074","032075","032076","032077","032078","032079","032080","032081","032082","032083","032084","032085","032086","032087","032088","032089","032090","032091","032092","032093","032094","032095","032096","032097","032098","032099","032100","033075","033076","033077","033078","033079","033080","033081","033082","033083","033084","033085","033086","033087","033088","033089","033090","033091","033092","033093","033094","033095","033096","033097","033098","033099","033100","034097","034099","034100","035089","035090","035091","035092","035093","035094","035095","035096","035097","035098","035099","035100","037095","037096","037097","037098","037099","037100","049060","049061","049062","049063","049064","049065","049066","049067","049068","049069","049070","049071","049072","049073","049074","049075","049076","049077","049078","049079","049080","049081","049082","049083","049084","049085","049086","049087","049088","049089","049090","049091","049092","049093","049094","049095","049096","049097","049098","049099","049100","053085","059083","059084","059085","059086","059087","059088","059089","059090","059091","059092","059093","059098","059099","070070","070071","070072","070073","070074","070075","070076","070077","070078","070079","070080","070081","070082","070083","070084","070085","070086","070087","070088","070089","070090","070091","070092","070093","070094","070095","070096","070097","070098","070099","070100","072097","072098","072099","072100","073068","073069","073070","073071","073072","073073","073074","073075","073076","073077","073078","073079","073080","073081","073082","073083","073084","073085","073086","073087","073088","073089","073090","073091","073092","073093","073094","073095","073096","073097","073098","073099","073100","075071","075072","075073","075074","075075","075076","075077","075078","075079","075080","075081","075082","075083","075084","075085","075086","075087","075088","075089","075090","075091","075092","075093","075094","075095","075096","075097","075098","075099","075100","076078","076079","076080","076081","076082","076083","076084","076085","076086","076087","076088","076089","076090","076091","076092","076093","076094","076095","076096","076097","076098","076099","076100","077078","077079","077080","077081","077082","077083","077084","077085","077086","077087","077088","077089","077090","077091","077092","077093","077094","077095","077096","077097","077098","077099","077100","078066","078067","078068","078069","078070","078071","078072","078073","078074","078075","078076","078077","078078","078079","078080","078081","078082","078083","078084","078085","078086","078087","078088","078089","078090","078091","078092","078093","078094","078095","078096","078097","078098","078099","078100","079092","079093","079094","079095","079096","079097","079098","079099","079100","080098","080099","080100","082081","082082","082083","082084","082085","082086","082087","082088","082089","082090","082091","082092","082093","082094","082095","082096","082097","082098","082099","082100","083067","083068","083069","083070","083071","083072","083073","083074","083075","083076","083077","083078","083079","083080","083081","083082","083083","083084","083085","083086","083087","083088","083089","083090","083091","083092","083093","083094","083095","083096","083097","083098","083099","083100","084080","084081","084082","084083","084084","084085","084086","084087","084088","084089","084090","084091","084092","084093","084094","084095","084096","084097","084098","084099","084100","087098","087099","088094","088095","088096","088097","088098","088099","088100","089064","089065","089069","089070","089071","089072","089073","089074","089075","089076","089077","089078","089079","089080","089081","089082","089083","089084","089085","089086","089087","089088","089089","089090","089091","089092","089093","089094","089095","089096","089097","089098","089099","089100","092083","092084","092085","092086","092087","092088","092089","092090","092091","092092","092093","092094","092095","092096","092097","092098","092099","092100","094092","094097","094098","094099","094100","095080","095081","095082","095083","095084","095085","095086","095087","095088","095089","095090","095091","095092","095093","095094","095095","095096","095097","095098","095099","095100","096068","096069","096070","096071","096072","096073","096074","096075","096076","096077","096078","096079","096080","096081","096082","096083","096084","096085","096086","096087","096088","096089","096090","096091","096092","096093","096094","096095","096096","096097","096098","096099","096100","098100","099069","099071","099072","099073","099074","099075","099076","099077","099078","099079","099080","099081","099082","099083","099084","099085","099086","099087","099088","099089","099090","099091","099092","099093","099094","099095","099096","099097","099098","099099","099100","101091","101092","101093","101094","101095","101096","101097","101098","101099","101100","102091","102092","102093","102094","102095","102096","102097","102098","102099","102100","103066","103077","103078","103079","103080","103081","103082","103083","103084","103085","103086","103087","103088","103089","103090","103091","103092","103093","103094","103095","103096","103097","103098","103099","103100","104081","104082","104083","104084","104085","104086","104087","104088","104089","104090","104091","104092","104093","104094","104095","104096","104097","104098","104099","104100","106058","106061","106069","106070","106071","106072","106073","106074","106075","106076","106077","106078","106079","106080","106081","106082","106083","106084","106085","106086","106087","106088","106089","106090","106091","106092","106093","106094","106095","106096","106097","106098","106099","106100","107080","107081","107082","107083","107084","107085","107086","107087","107088","107089","107090","107091","107092","107093","107094","107095","107096","107097","107098","107099","107100","108097","108098","108099","108100","109094","109095","109096","109097","109098","109099","109100","110078","110079","110080","110081","110082","110083","110084","110085","110086","110087","110088","110089","110090","110091","110092","110093","110094","110095","110096","110097","110098","110099","110100","112093","112094","112095","112096","112097","112098","112099","112100","113082","113083","113084","113085","113086","113087","113088","113089","113090","113091","113092","113093","113094","113095","113096","113097","113098","113099","113100","114068","114069","114070","114071","114072","114073","114074","114075","114076","114077","114078","114079","114080","114081","114082","114083","114084","114085","114086","114087","114088","114089","114090","114091","114092","114093","114094","114095","114096","114097","114098","114099","114100","116067","116068","116069","116070","116071","116072","116073","116074","116075","116076","116077","116078","116079","116080","116095","116096","116098","116099","116100","122075","122076","122077","122078","122079","122080","122081","122082","122083","122084","122085","122086","122087","122088","122089","122090","122091","122092","122093","122094","122095","122096","122097","122098","122099","122100","124082","124083","124084","124085","124086","124087","124088","124089","124090","124091","124092","124093","124094","124095","124096","124097","124098","124099","124100","125100","126099","126100","127054","127055","127056","127057","127058","127059","127090","127091","127092","127093","127094","127095","127096","127097","127098","127099","127100","128065","128070","128074","128093","128094","128095","128096","128097","128098","128099","128100","132057","132058","132059","132060","132061","132062","132063","132064","132065","132066","132067","132068","132069","132070","132071","132072","132073","132074","132075","132076","132077","132078","132079","132080","132081","132082","132083","132084","132085","132086","132087","132088","132089","132090","132091","132092","132093","132094","132095","132096","132097","132098","132099","132100","134092","138050","138051","138052","138053","138054","138055","138056","138057","138058","138059","138060","138061","138062","138063","138064","138065","138066","138067","138068","138069","138070","138071","138072","138073","138074","138075","138076","138077","138078","138079","138080","138081","138082","138083","138084","138085","138086","138087","138088","138089","138090","138091","138092","138093","138094","138095","138096","138097","138098","138099","138100"]
name = []
name1 = []
for i in range(140):
        for j in range(100):
                if not ("%03d%03d" % (i+1,j+1)) in err_case:
                        key = ("result_step_%03d%03d.csv" % (i+1,j+1))
                        key1 = ("newDI_step_%03d%03d.csv" % (i+1,j+1))
                        name.append(key)
                        name1.append(key1)
std = ["STD_1F","STD_2F","STD_3F","STD_4F","STD_5F","STD_6F","STD_7F","STD_8F","STD_9F","STD_10F","STD_11F","STD_12F","STD_13F","STD_14F","STD_15F","STD_16F","STD_17F","STD_18F"]
#lbl = ["DI_1F","DI_2F","DI_3F","DI_4F","DI_5F","DI_6F","DI_7F","DI_8F","DI_9F","DI_10F","DI_11F","DI_12F","DI_13F","DI_14F","DI_15F","DI_16F","DI_17F","DI_18F"]
#std = ['ACC_2FL','ACC_3FL','ACC_4FL','ACC_5FL','ACC_6FL','ACC_7FL','ACC_8FL','ACC_9FL','ACC_10FL','ACC_11FL','ACC_12FL','ACC_13FL','ACC_14FL','ACC_15FL','ACC_16FL','ACC_17FL','ACC_18FL','ACC_RFL']
lbl = ["maxDI_1F","maxDI_2F","maxDI_3F","maxDI_4F","maxDI_5F","maxDI_6F","maxDI_7F","maxDI_8F","maxDI_9F","maxDI_10F","maxDI_11F","maxDI_12F","maxDI_13F","maxDI_14F","maxDI_15F","maxDI_16F","maxDI_17F","maxDI_18F"]

lbl1 = ['DI_1F','DI_2F','DI_3F','DI_4F','DI_5F','DI_6F','DI_7F','DI_8F','DI_9F','DI_10F','DI_11F','DI_12F','DI_13F','DI_14F','DI_15F','DI_16F','DI_17F','DI_18F']

#maxx = 6.749
#minn = -6.747999999999999
maxx=8
minn=-8

# default = 180
pic_length = 360

s3 = boto3.client('s3')


def label_settings_3class(x):
        d = np.zeros(18*3)
        for i in range(len(x)):
                if x[i]=='1':
                        d[i*3+int(x[i])-1]=1.0
                if x[i]=='2':
                        d[i*3+int(x[i])-1]=1.0
                if x[i]=='3':
                        d[i*3+int(x[i])-2]=1.0
                if x[i]=='4':
                        d[i*3+int(x[i])-3]=1.0
                if x[i]=='5':
                        d[i*3+int(x[i])-3]=1.0
        #print(d, len(d))
        return d/18

test_name=[]
learn_name=[]


start=121
end=140



learn_labels = []
learn_images = []
test_labels = []
test_images = []

pic_name = {}
pic_name['filename']=[]

def check_func(x):
	if '111111111111111111' ==  x and random.random() > 0.02:
		return False
	else: 
		return True
#for n in name:
def d2_to_d3(arr):
	res=[]
	for x in arr:
		v1=[]
		for y in x:
			v1.append([y])
		res.append(v1)
	return res

	
for n, n1 in zip(name, name1):
	print(n,'newDI/'+n1)
	obj = s3.get_object(Bucket='takenaka', Key=n)
	obj1 = s3.get_object(Bucket='takenaka', Key='newDI/'+n1)
	data = pd.read_csv(io.BytesIO(obj['Body'].read()))
	label = pd.read_csv(io.BytesIO(obj1['Body'].read()))
	#print(label)
	row_number = len(data.index)
	#print(data.shape, label.shape)
	for i in range(int(row_number/pic_length)):
		if check_func("".join(map(str,label.iloc[i*pic_length:i*pic_length+pic_length][lbl1].max().tolist()))):
			#img2 = Image.new('RGB', (18, pic_length))
			pic = data.iloc[i*pic_length:i*pic_length+pic_length][std]#*16+128 #16=128/maxx
			#print(pic)
			pic = pic.values.tolist()
			#print(np.array(pic))
			#print(int(n[12:15]))
			if int(n[12:15]) >=start and int(n[12:15]) <=end:
				test_images.append(d2_to_d3(pic))
				test_labels.append(label_settings_3class("".join(map(str,label.iloc[i*pic_length:i*pic_length+pic_length][lbl1].max().tolist()))))
			else:
				learn_images.append(d2_to_d3(pic))
				learn_labels.append(label_settings_3class("".join(map(str,label.iloc[i*pic_length:i*pic_length+pic_length][lbl1].max().tolist()))))
			pic_name['filename'].append(n[12:18]+str(i)+'_'+"".join(map(str,label.iloc[i*pic_length:i*pic_length+pic_length][lbl1].max().tolist()))+'.jpg')
			#print(pd.DataFrame.from_dict(pic_name))
			#for y in range(pic_length):
  			#	for x in range(18):
  			#		R=G=B=int(pic[y][x])
  			#		img2.putpixel((x,y), (R, G, B))
			#img2.save("pic/"+n[12:18]+str(i)+'_'+"".join(map(str,label.iloc[i*pic_length:i*pic_length+pic_length][lbl1].max().tolist()))+'.jpg')

pic_file=pd.DataFrame.from_dict(pic_name)
pic_file.to_csv('pic_name_new.csv',index=False)

print(len(learn_images))
print(len(learn_images[0]))
print(len(learn_images[0][0]))
#print(len(learn_images[0][0][0]))

print("Total learn_dataset: " + str(len(learn_images)))
print("Total test_dataset: " + str(len(test_images)))


np.save("l%03d_%03d_for_test/learn_data.npy" % (start,end), learn_images)
np.save("l%03d_%03d_for_test/learn_labels.npy" % (start,end), learn_labels)
np.save("l%03d_%03d_for_test/test_data.npy" % (start,end), test_images)
np.save("l%03d_%03d_for_test/test_labels.npy" % (start,end), test_labels)

